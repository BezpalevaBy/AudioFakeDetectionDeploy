<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepfake Audio Detection System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #4CAF50;
        }
        
        .header h1 {
            margin: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-online {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .upload-section {
            margin: 30px 0;
            padding: 30px;
            border: 3px dashed #b8b8b8;
            border-radius: 10px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }
        
        .upload-section.drag-over {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }
        
        .upload-section:hover {
            border-color: #4CAF50;
        }
        
        .file-input-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #3d8b40;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-container {
            margin-top: 30px;
            display: none;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .result-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .result-badge {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .real {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .fake {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .confidence-meter {
            height: 25px;
            background-color: #eee;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 1s ease;
        }
        
        .confidence-high {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        
        .confidence-medium {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }
        
        .confidence-low {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }
        
        .confidence-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            color: #333;
        }
        
        .details-section {
            margin-top: 30px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .detail-card {
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }
        
        .detail-card h4 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spectrogram-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .spectrogram-img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }
        
        .anomaly-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 0.7);
            border: 2px solid #dc3545;
            transform: translate(-50%, -50%);
            cursor: help;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-top: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }
        
        .tab.active {
            border-bottom: 3px solid #4CAF50;
            color: #4CAF50;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .recommendations {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .recommendations ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .history-section {
            margin-top: 40px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .history-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .history-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 14px;
        }
        
        .api-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .api-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s;
        }
        
        .api-link:hover {
            background-color: #dee2e6;
            color: #212529;
        }
        
        /* Новые стили для расширенного функционала */
        .analysis-options {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            align-items: center;
            justify-content: center;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .option-label input[type="checkbox"],
        .option-label input[type="radio"] {
            margin-right: 5px;
        }
        
        .format-select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            background-color: white;
            cursor: pointer;
        }
        
        .batch-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .batch-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .batch-file-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        
        .batch-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .batch-file-item:last-child {
            border-bottom: none;
        }
        
        .file-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: #e9ecef;
        }
        
        .status-processing {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .spectrogram-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .quality-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .quality-good {
            background-color: #d4edda;
            color: #155724;
        }
        
        .quality-fair {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .quality-poor {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        .confidence-level {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .level-high {
            background-color: #d4edda;
            color: #155724;
        }
        
        .level-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .level-low {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-btn {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .streaming-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .streaming-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stream-status {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .option-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            button {
                width: 100%;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .streaming-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-wave-square"></i> Deepfake Audio Detection System</h1>
            <div class="header-actions">
                <div class="status-badge status-online" id="systemStatus">
                    <i class="fas fa-circle"></i> Система активна
                </div>
            </div>
        </div>
        
        <p>Загрузите аудиофайл для проверки на наличие синтезированного (deepfake) аудио. Система анализирует файлы формата WAV длительностью от 5 секунд до 5 минут.</p>
        
        <!-- Модальное окно пакетной обработки -->
        <div class="batch-modal" id="batchModal">
            <div class="batch-modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-folder-open"></i> Пакетная обработка</h3>
                    <button class="modal-close" onclick="closeBatchModal()">&times;</button>
                </div>
                
                <div id="batchUploadArea" class="upload-section" style="margin: 0 0 20px 0;">
                    <h4><i class="fas fa-cloud-upload-alt"></i> Загрузите файлы</h4>
                    <p>Перетащите файлы сюда или нажмите для выбора</p>
                    <div class="file-input-container">
                        <input type="file" id="batchFiles" accept="audio/*" multiple>
                        <div class="file-input-label">
                            <i class="fas fa-file-audio"></i> Выбрать файлы
                        </div>
                    </div>
                </div>
                
                <div class="file-info" id="batchFileInfo">
                    <p><strong>Выбрано файлов:</strong> <span id="batchFileCount">0</span></p>
                    <p><strong>Общий размер:</strong> <span id="batchTotalSize">0 MB</span></p>
                </div>
                
                <div class="batch-file-list" id="batchFileList">
                    <!-- Список файлов будет добавляться динамически -->
                </div>
                
                <div class="analysis-options" hidden>
                    <h4><i class="fas fa-cog"></i> Настройки анализа</h4>
                    <div class="option-group">
                        <div>
                            <label for="batchFormat">Формат отчета:</label>
                            <select id="batchFormat" class="format-select">
                                <option value="json">JSON</option>
                                <option value="text">Текст</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="progress-container" id="batchProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="batchProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="batchProgressText">Ожидание начала обработки...</div>
                </div>
                
                <div class="controls">
                    <button onclick="startBatchProcessing()" id="startBatchBtn">
                        <i class="fas fa-play"></i> Начать обработку
                    </button>
                    <button onclick="closeBatchModal()" class="secondary">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </div>
        </div>
        
        <div class="upload-section" id="uploadArea">
            <h3><i class="fas fa-cloud-upload-alt"></i> Загрузить аудиофайл</h3>
            <p>Перетащите файл сюда или нажмите кнопку для выбора</p>
            
            <div class="file-input-container">
                <input type="file" id="audioFile" accept="audio/*">
                <div class="file-input-label">
                    <i class="fas fa-file-audio"></i> Выбрать аудиофайл
                </div>
            </div>
            
            <div class="file-info" id="fileInfo">
                <p><strong>Файл:</strong> <span id="fileName"></span></p>
                <p><strong>Размер:</strong> <span id="fileSize"></span> MB</p>
                <p><strong>Длительность:</strong> <span id="fileDuration"></span></p>
                <p><strong>Качество:</strong> <span id="fileQuality">Проверяется...</span></p>
            </div>
            
            <div class="analysis-options">
                <h4><i class="fas fa-cog"></i> Настройки анализа</h4>
                <div class="option-group">
                    <label class="option-label">
                        <input type="checkbox" id="detailedAnalysis" checked hidden>
                    </label>
                    <label class="option-label">
                        <input type="checkbox" id="generateSpectrogram" checked>
                        Генерация спектрограммы
                    </label>
                    <div>
                        <label for="returnFormat">Формат отчета:</label>
                        <select id="returnFormat" class="format-select">
                            <option value="json">JSON</option>
                            <option value="text">Текст</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button onclick="validateAudio()" id="validateBtn" class="secondary">
                    <i class="fas fa-check-circle"></i> Проверить файл
                </button>
                <button onclick="analyzeAudio()" id="analyzeBtn">
                    <i class="fas fa-search"></i> Анализировать аудио
                </button>
                <button onclick="clearFile()" class="secondary" id="clearBtn">
                    <i class="fas fa-trash-alt"></i> Очистить
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingMessage">Идет анализ аудиофайла...</p>
                <p id="loadingDetails">Извлечение признаков, классификация...</p>
            </div>
        </div>
        
        <!-- Стриминговая обработка -->
        <div class="streaming-section">
            <h3><i class="fas fa-stream"></i> Анализ в реальном времени</h3>
            <p>Подключитесь через WebSocket для анализа аудио потока в реальном времени</p>
            <div class="streaming-controls">
                <button onclick="startStreaming()" id="startStreamBtn">
                    <i class="fas fa-play"></i> Начать стриминг
                </button>
                <button onclick="stopStreaming()" id="stopStreamBtn" class="secondary" disabled>
                    <i class="fas fa-stop"></i> Остановить
                </button>
                <button onclick="connectWebSocket()" id="connectWsBtn" class="secondary">
                    <i class="fas fa-plug"></i> Подключиться
                </button>
            </div>
            <div class="stream-status" id="streamStatus">
                Статус: Не подключено
            </div>
            <div id="streamResults" style="display: none; margin-top: 15px;">
                <!-- Результаты стриминга будут отображаться здесь -->
            </div>
        </div>
        
        <div class="controls" style="margin-top: 20px;">
            <button onclick="openBatchModal()" class="secondary">
                <i class="fas fa-folder-open"></i> Пакетная обработка
            </button>
        </div>
        
        <div class="result-container" id="resultContainer">
            <div class="result-header">
                <h2><i class="fas fa-chart-bar"></i> Результаты анализа</h2>
                <div class="export-options">
                    <button onclick="exportResults('text')" class="secondary export-btn">
                        <i class="fas fa-file-alt"></i> Скачать
                    </button>
                </div>
            </div>
            
            <div class="result-card">
                <div class="result-badge" id="resultBadge">
                    <i class="fas fa-question-circle"></i> Ожидание анализа
                </div>
                
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Уровень уверенности модели</h3>
                        <div class="confidence-level" id="confidenceLevel">НЕИЗВЕСТНО</div>
                    </div>
                    <div class="confidence-meter">
                        <div class="confidence-fill" id="confidenceFill"></div>
                        <div class="confidence-text" id="confidenceText">0%</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('summary')">Сводка</div>
                    <div class="tab" onclick="switchTab('spectrogram')">Спектрограмма</div>
                    <div class="tab" onclick="switchTab('recommendations')">Рекомендации</div>
                    <div class="tab" onclick="switchTab('technical')">Технические данные</div>
                </div>
                
                <div class="tab-content active" id="summaryTab">
                    <div style="margin: 20px 0;">
                        <h3><i class="fas fa-info-circle"></i> Основные показатели</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="realProbability">-</div>
                                <div class="stat-label">Вероятность REAL</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="fakeProbability">-</div>
                                <div class="stat-label">Вероятность FAKE</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="processingTimeVal">-</div>
                                <div class="stat-label">Время обработки</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="audioDuration">-</div>
                                <div class="stat-label">Длительность</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="details-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-microphone"></i> Информация о файле</h4>
                            <p id="fileDetails">Не загружен</p>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-robot"></i> Вердикт модели</h4>
                            <p id="modelVerdict">Ожидание анализа</p>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-clock"></i> Время обработки</h4>
                            <p id="processingTime">-</p>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-chart-line"></i> Метрики модели</h4>
                            <p id="accuracyMetrics">Precision: - | Recall: - | F1: -</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3><i class="fas fa-play-circle"></i> Аудиоплеер</h3>
                        <audio controls class="audio-player" id="audioPlayer">
                            Ваш браузер не поддерживает аудио элементы.
                        </audio>
                    </div>
                </div>
                
                <div class="tab-content" id="detailsTab">
                    <h3><i class="fas fa-search"></i> Детализированный анализ артефактов</h3>
                    <div class="details-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-wave-square"></i> Частотный спектр</h4>
                            <p id="spectrumAnalysis">Анализ не выполнен</p>
                            <div id="spectralAnomalies"></div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-exchange-alt"></i> Переходы между фонемами</h4>
                            <p id="phonemeTransitions">Анализ не выполнен</p>
                            <div id="phonemeIssues"></div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-bug"></i> Артефакты вокодера</h4>
                            <p id="vocoderArtifacts">Анализ не выполнен</p>
                            <div id="vocoderIssues"></div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-chart-bar"></i> Статистические аномалии</h4>
                            <p id="statisticalAnalysis">Анализ не выполнен</p>
                            <div id="statisticalIssues"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="spectrogramTab">
                    <h3><i class="fas fa-image"></i> Визуализация спектрограммы</h3>
                    <div class="spectrogram-container">
                        <div style="position: relative; display: inline-block;">
                            <img id="spectrogramImg" style="display:none; max-width:100%;" />
                            <div id="anomalyMarkers"></div>
                        </div>
                    </div>
                    <div class="spectrogram-controls">
                        <button onclick="downloadSpectrogram()" class="secondary">
                            <i class="fas fa-download"></i> Скачать
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="recommendationsTab">
                    <h3><i class="fas fa-clipboard-check"></i> Рекомендации по проверке</h3>
                    <div class="recommendations">
                        <p id="recommendationsHeader"><strong>Если система определила аудио как подозрительное, рекомендуется:</strong></p>
                        <ul id="recommendationsList">
                            <li>Провести дополнительный анализ с использованием других методов</li>
                            <li>Проверить источник аудиозаписи</li>
                            <li>Сравнить с оригинальными записями (если доступны)</li>
                            <li>Обратиться к экспертам в области цифровой обработки сигналов</li>
                            <li>Использовать несколько систем детекции для подтверждения результата</li>
                        </ul>
                    </div>
                </div>
                
                <div class="tab-content" id="qualityTab">
                    <h3><i class="fas fa-tachometer-alt"></i> Анализ качества аудио</h3>
                    <div class="details-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-volume-up"></i> Signal-to-Noise Ratio</h4>
                            <p id="snrValue">- dB</p>
                            <div id="snrIndicator" class="quality-indicator quality-fair">Среднее</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-waveform"></i> Динамический диапазон</h4>
                            <p id="dynamicRangeValue">- dB</p>
                            <div id="dynamicRangeIndicator" class="quality-indicator quality-fair">Среднее</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-music"></i> Гармонический коэффициент</h4>
                            <p id="harmonicRatioValue">- %</p>
                            <div id="harmonicRatioIndicator" class="quality-indicator quality-fair">Среднее</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-file-audio"></i> Технические параметры</h4>
                            <p id="sampleRateValue">- Hz</p>
                            <p id="bitDepthValue">- bit</p>
                            <div id="qualityScoreIndicator" class="quality-indicator quality-fair">Общий балл: -</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Оценка качества записи:</h4>
                        <div class="progress-bar" style="height: 25px;">
                            <div class="progress-fill" id="qualityProgress" style="width: 0%"></div>
                        </div>
                        <p id="qualityAssessment">Качество аудио не оценено</p>
                    </div>
                </div>
                
                <div class="tab-content" id="technicalTab">
                    <h3><i class="fas fa-code"></i> Технические данные</h3>
                    <div class="details-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-cogs"></i> Конфигурация анализа</h4>
                            <p id="analysisType">-</p>
                            <p id="targetSampleRate">- Hz</p>
                            <p id="audioLength">- samples</p>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-database"></i> Метаданные</h4>
                            <p id="inferenceId">-</p>
                            <p id="analysisTimestamp">-</p>
                            <p id="apiVersion">v2.0</p>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-chart-pie"></i> Статистика системы</h4>
                            <p id="systemRequests">- запросов</p>
                            <p id="systemAccuracy">- точность</p>
                            <p id="systemUptime">- время работы</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="showRawData()" class="secondary">
                            <i class="fas fa-code"></i> Показать сырые данные
                        </button>
                        <button onclick="downloadTechnicalReport()" class="secondary" style="margin-left: 10px;">
                            <i class="fas fa-download"></i> Скачать технический отчет
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="history-section" id="historySection">
            <h3><i class="fas fa-history"></i> История проверок</h3>
            <div class="controls" style="margin-bottom: 15px;">
                <button onclick="refreshHistory()" class="secondary">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
                <button onclick="exportHistory()" class="secondary">
                    <i class="fas fa-download"></i> Экспорт истории
                </button>
                <button onclick="clearHistory()" class="secondary">
                    <i class="fas fa-trash"></i> Очистить историю
                </button>
            </div>
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>Время</th>
                        <th>Файл</th>
                        <th>Результат</th>
                        <th>Уверенность</th>
                        <th>Качество</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- История будет загружена динамически -->
                </tbody>
            </table>
            <div style="text-align: center; margin-top: 15px;">
                <p id="historyStats">Записей в истории: 0</p>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3><i class="fas fa-plug"></i> API и интеграция</h3>
            <p>Система предоставляет REST API для интеграции с другими сервисами</p>
            <div class="api-links">
                <a href="/api/docs" target="_blank" class="api-link">
                    <i class="fas fa-book"></i> API Документация
                </a>
                <a href="/health" target="_blank" class="api-link">
                    <i class="fas fa-heartbeat"></i> Health Check
                </a>
                <a href="/api/metrics" target="_blank" class="api-link">
                    <i class="fas fa-chart-bar"></i> System Metrics
                </a>
                <a href="/api/model/info" target="_blank" class="api-link">
                    <i class="fas fa-brain"></i> Model Info
                </a>
            </div>
        </div>
    </div>

    <script>
        // Элементы DOM
        const audioFileInput = document.getElementById('audioFile');
        const fileInfoDiv = document.getElementById('fileInfo');
        const fileNameSpan = document.getElementById('fileName');
        const fileSizeSpan = document.getElementById('fileSize');
        const fileDurationSpan = document.getElementById('fileDuration');
        const fileQualitySpan = document.getElementById('fileQuality');
        const loadingDiv = document.getElementById('loading');
        const loadingMessageSpan = document.getElementById('loadingMessage');
        const loadingDetailsSpan = document.getElementById('loadingDetails');
        const resultContainer = document.getElementById('resultContainer');
        const resultBadge = document.getElementById('resultBadge');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        const confidenceLevelDiv = document.getElementById('confidenceLevel');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const validateBtn = document.getElementById('validateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const uploadArea = document.getElementById('uploadArea');
        const audioPlayer = document.getElementById('audioPlayer');
        const spectrogramImg = document.getElementById('spectrogramImg');
        const anomalyMarkers = document.getElementById('anomalyMarkers');
        const systemStatusBadge = document.getElementById('systemStatus');
        
        // Элементы пакетной обработки
        const batchModal = document.getElementById('batchModal');
        const batchFilesInput = document.getElementById('batchFiles');
        const batchFileInfo = document.getElementById('batchFileInfo');
        const batchFileCount = document.getElementById('batchFileCount');
        const batchTotalSize = document.getElementById('batchTotalSize');
        const batchFileList = document.getElementById('batchFileList');
        const batchProgress = document.getElementById('batchProgress');
        const batchProgressFill = document.getElementById('batchProgressFill');
        const batchProgressText = document.getElementById('batchProgressText');
        const startBatchBtn = document.getElementById('startBatchBtn');
        
        // Элементы стриминга
        const startStreamBtn = document.getElementById('startStreamBtn');
        const stopStreamBtn = document.getElementById('stopStreamBtn');
        const connectWsBtn = document.getElementById('connectWsBtn');
        const streamStatus = document.getElementById('streamStatus');
        const streamResults = document.getElementById('streamResults');
        
        // Переменные состояния
        let currentFile = null;
        let analysisResults = null;
        let history = JSON.parse(localStorage.getItem('audioAnalysisHistory')) || [];
        let batchFiles = [];
        let websocket = null;
        let isStreaming = false;
        let streamChunks = [];
        let batchTaskId = null;
        let batchStatusInterval = null;
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            updateSystemStatus();
            setupBatchFileInput();
            setupStreaming();
        });
        
        // === ОСНОВНЫЕ ФУНКЦИИ ===
        
        // Обновление статуса системы
        async function updateSystemStatus() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    const data = await response.json();
                    systemStatusBadge.className = 'status-badge status-online';
                    systemStatusBadge.innerHTML = `<i class="fas fa-circle"></i> Система активна (${data.version?.api || 'v2.0'})`;
                    document.title = `Deepfake Audio Detection System (${data.status})`;
                } else {
                    systemStatusBadge.className = 'status-badge status-offline';
                    systemStatusBadge.innerHTML = '<i class="fas fa-circle"></i> Система неактивна';
                }
            } catch (error) {
                systemStatusBadge.className = 'status-badge status-offline';
                systemStatusBadge.innerHTML = '<i class="fas fa-circle"></i> Система неактивна';
            }
        }
        
        // Обработка выбора файла
        audioFileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                currentFile = e.target.files[0];
                displayFileInfo(currentFile);
                analyzeBtn.disabled = false;
                validateBtn.disabled = false;
                clearBtn.disabled = false;
                
                // Загрузить файл в аудиоплеер
                const audioURL = URL.createObjectURL(currentFile);
                audioPlayer.src = audioURL;
                
                // Показать контейнер результатов
                resultContainer.style.display = 'block';
                
                // Сбросить предыдущие результаты
                resetResults();
                
                // Автоматическая валидация
                setTimeout(() => validateAudio(), 500);
            }
        });
        
        // Отображение информации о файле
        async function displayFileInfo(file) {
            fileNameSpan.textContent = file.name;
            fileSizeSpan.textContent = (file.size / (1024 * 1024)).toFixed(2);
            fileDurationSpan.textContent = 'Определяется...';
            fileQualitySpan.textContent = 'Проверяется...';
            
            // Определение длительности аудио
            const audio = new Audio();
            audio.src = URL.createObjectURL(file);
            audio.addEventListener('loadedmetadata', function() {
                const duration = audio.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                fileDurationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Обновить информацию в сводке
                document.getElementById('fileDetails').textContent = 
                    `${file.name} | ${(file.size / (1024 * 1024)).toFixed(2)} MB | ${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('audioDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });
            
            fileInfoDiv.style.display = 'block';
        }
        
        // Валидация аудиофайла
        async function validateAudio() {
            if (!currentFile) {
                alert('Пожалуйста, выберите аудиофайл');
                return;
            }
            
            loadingMessageSpan.textContent = 'Валидация аудиофайла...';
            loadingDetailsSpan.textContent = 'Проверка формата, размера и качества...';
            loadingDiv.style.display = 'block';
            
            const formData = new FormData();
            formData.append('file', currentFile);
            
            try {
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! статус: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.valid) {
                    fileQualitySpan.innerHTML = `<span class="quality-indicator quality-good">✓ Готов к анализу</span>`;
                    fileQualitySpan.title = `Частота: ${data.file_info.sample_rate}Hz, Длительность: ${data.file_info.duration_seconds.toFixed(1)}с, SNR: ${data.file_info.snr_db.toFixed(1)}dB`;
                    
                    // Проверить нужно ли конвертировать
                    if (data.compatibility.needs_conversion) {
                        fileQualitySpan.innerHTML += `<br><span class="quality-indicator quality-fair">⚠ Требуется конвертация</span>`;
                    }
                } else {
                    fileQualitySpan.innerHTML = `<span class="quality-indicator quality-poor">✗ ${data.error}</span>`;
                    analyzeBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('Ошибка валидации:', error);
                fileQualitySpan.innerHTML = `<span class="quality-indicator quality-poor">✗ Ошибка проверки</span>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Анализ аудио
        async function analyzeAudio() {
            if (!currentFile) {
                alert('Пожалуйста, выберите аудиофайл');
                return;
            }
            
            // Проверка формата и размера
            if (currentFile.size > 100 * 1024 * 1024) { // 100MB limit
                alert('Файл слишком большой. Максимальный размер: 100MB');
                return;
            }
            
            // Показать индикатор загрузки
            loadingMessageSpan.textContent = 'Анализ аудиофайла...';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;
            
            // Имитация прогресса анализа
            const loadingSteps = [
                'Загрузка аудиофайла...',
                'Извлечение аудио признаков...',
                'Анализ частотного спектра...',
                'Проверка переходов между фонемами...',
                'Поиск артефактов вокодера...',
                'Статистический анализ...',
                'Классификация с помощью нейронной сети...',
                'Формирование отчета...'
            ];
            
            let step = 0;
            const loadingInterval = setInterval(() => {
                loadingDetailsSpan.textContent = loadingSteps[step];
                step = (step + 1) % loadingSteps.length;
            }, 800);
            
            try {
                // Отправка файла на сервер
                const formData = new FormData();
                formData.append('file', currentFile);
                
                // Добавляем параметры анализа
                const detailed = document.getElementById('detailedAnalysis').checked;
                const spectrogram = document.getElementById('generateSpectrogram').checked;
                const format = document.getElementById('returnFormat').value;
                
                const url = `/api/analyze?detailed=${detailed}&generate_spectrogram=${spectrogram}&return_format=${format}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! статус: ${response.status}`);
                }
                
                let data;
                if (format === 'json') {
                    data = await response.json();
                } else if (format === 'text') {
                    data = { text: await response.text() };
                }
                
                analysisResults = data;
                
                // Сохранить в историю
                saveToHistory(currentFile.name, data);
                
                // Отобразить результаты
                displayResults(data);
                
            } catch (error) {
                console.error('Ошибка анализа:', error);
                alert(`Ошибка при анализе аудио: ${error.message}`);
            } finally {
                // Скрыть индикатор загрузки
                clearInterval(loadingInterval);
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }
        
        // Отображение результатов
        function displayResults(data) {
            // Проверка формата ответа
            if (data.text) {
                // Текстовый формат
                document.getElementById('resultBadge').innerHTML = '<i class="fas fa-file-alt"></i> Текстовый отчет';
                document.getElementById('summaryTab').innerHTML = `<pre>${data.text}</pre>`;
                return;
            }
            
            if (data.html) {
                // HTML формат
                document.getElementById('resultBadge').innerHTML = '<i class="fas fa-file-code"></i> HTML отчет';
                document.getElementById('summaryTab').innerHTML = data.html;
                return;
            }
            
            // JSON формат - полный анализ
            const isFake = data.is_fake;
            const confidence = data.confidence || 0.5;
            const confidencePercent = Math.round(confidence * 100);
            
            // Обновить бейдж результата
            if (isFake) {
                resultBadge.className = 'result-badge fake';
                resultBadge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Синтезированное (FAKE) аудио`;
                document.getElementById('modelVerdict').textContent = 'СИНТЕЗИРОВАННОЕ (FAKE) аудио';
            } else {
                resultBadge.className = 'result-badge real';
                resultBadge.innerHTML = `<i class="fas fa-check-circle"></i> Настоящее (REAL) аудио`;
                document.getElementById('modelVerdict').textContent = 'НАСТОЯЩЕЕ (REAL) аудио';
            }
            
            // Обновить индикатор уверенности
            confidenceText.textContent = `${confidencePercent}%`;
            confidenceFill.style.width = `${confidencePercent}%`;
            
            // Установить цвет и уровень уверенности
            let confidenceClass, levelText;
            if (confidencePercent >= 85) {
                confidenceFill.className = 'confidence-fill confidence-high';
                confidenceClass = 'level-high';
                levelText = 'ВЫСОКАЯ';
            } else if (confidencePercent >= 60) {
                confidenceFill.className = 'confidence-fill confidence-medium';
                confidenceClass = 'level-medium';
                levelText = 'СРЕДНЯЯ';
            } else {
                confidenceFill.className = 'confidence-fill confidence-low';
                confidenceClass = 'level-low';
                levelText = 'НИЗКАЯ';
            }
            
            confidenceLevelDiv.className = `confidence-level ${confidenceClass}`;
            confidenceLevelDiv.textContent = levelText;
            
            // Вероятности классов
            if (data.probabilities) {
                document.getElementById('realProbability').textContent = `${Math.round(data.probabilities.real * 100)}%`;
                document.getElementById('fakeProbability').textContent = `${Math.round(data.probabilities.fake * 100)}%`;
            }
            
            // Время обработки
            const processingTime = data.processing_time_seconds || data.processing_time || 0;
            document.getElementById('processingTime').textContent = `${processingTime.toFixed(2)}s`;
            document.getElementById('processingTimeVal').textContent = `${processingTime.toFixed(2)}s`;
            
            // Детализированный анализ
            if (data.analysis && data.analysis.artifacts) {
                const artifacts = data.analysis.artifacts;
                
                // Спектральные аномалии
                if (artifacts.spectral_anomalies) {
                    document.getElementById('spectrumAnalysis').textContent = artifacts.spectral_anomalies.join(', ') || 'Незначительные аномалии не обнаружены';
                    if (artifacts.spectral_anomalies.length > 0) {
                        document.getElementById('spectralAnomalies').innerHTML = 
                            `<div class="quality-indicator quality-poor">Обнаружено: ${artifacts.spectral_anomalies.length} аномалий</div>`;
                    }
                }
                
                // Фонемные переходы
                if (artifacts.phoneme_transitions) {
                    document.getElementById('phonemeTransitions').textContent = artifacts.phoneme_transitions.join(', ') || 'Переходы между звуками в пределах нормы';
                    if (artifacts.phoneme_transitions.length > 0) {
                        document.getElementById('phonemeIssues').innerHTML = 
                            `<div class="quality-indicator quality-fair">Обнаружено: ${artifacts.phoneme_transitions.length} проблем</div>`;
                    }
                }
                
                // Артефакты вокодера
                if (artifacts.vocoder_artifacts) {
                    document.getElementById('vocoderArtifacts').textContent = artifacts.vocoder_artifacts.join(', ') || 'Артефакты вокодера не обнаружены';
                    if (artifacts.vocoder_artifacts.length > 0) {
                        document.getElementById('vocoderIssues').innerHTML = 
                            `<div class="quality-indicator quality-poor">Обнаружено: ${artifacts.vocoder_artifacts.length} артефактов</div>`;
                    }
                }
                
                // Статистические аномалии
                if (artifacts.statistical_anomalies) {
                    document.getElementById('statisticalAnalysis').textContent = artifacts.statistical_anomalies.join(', ') || 'Статистические параметры в норме';
                    if (artifacts.statistical_anomalies.length > 0) {
                        document.getElementById('statisticalIssues').innerHTML = 
                            `<div class="quality-indicator quality-fair">Обнаружено: ${artifacts.statistical_anomalies.length} отклонений</div>`;
                    }
                }
            }
            
            // Качество аудио
            if (data.analysis && data.analysis.audio_quality) {
                const quality = data.analysis.audio_quality;
                
                document.getElementById('snrValue').textContent = `${quality.snr_db.toFixed(1)} dB`;
                document.getElementById('dynamicRangeValue').textContent = `${quality.dynamic_range_db.toFixed(1)} dB`;
                document.getElementById('harmonicRatioValue').textContent = `${(quality.harmonic_ratio * 100).toFixed(1)}%`;
                document.getElementById('sampleRateValue').textContent = `${quality.sample_rate} Hz`;
                
                // Индикаторы качества
                updateQualityIndicator('snrIndicator', quality.snr_db, 20, 10);
                updateQualityIndicator('dynamicRangeIndicator', quality.dynamic_range_db, 40, 20);
                updateQualityIndicator('harmonicRatioIndicator', quality.harmonic_ratio * 100, 60, 30);
                
                // Общая оценка качества
                const qualityScore = calculateQualityScore(quality);
                document.getElementById('qualityProgress').style.width = `${qualityScore}%`;
                document.getElementById('qualityAssessment').textContent = getQualityAssessment(qualityScore);
                document.getElementById('qualityScoreIndicator').textContent = `Общий балл: ${qualityScore.toFixed(1)}/100`;
            }
            
            // Рекомендации
            if (data.recommendations) {
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsList.innerHTML = '';
                data.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
                
                document.getElementById('recommendationsHeader').innerHTML = 
                    `<strong>На основе анализа сформированы рекомендации:</strong>`;
            }
            
            // Технические данные
            
            if (data.audio_info) {
                document.getElementById('targetSampleRate').textContent = `${data.audio_info.sample_rate} Hz`;
                document.getElementById('audioLength').textContent = `${data.audio_info.duration_seconds.toFixed(1)}s`;
            }
            
            if (data.inference_id) {
                document.getElementById('inferenceId').textContent = data.inference_id;
            }
            
            if (data.timestamp) {
                document.getElementById('analysisTimestamp').textContent = new Date(data.timestamp).toLocaleString();
            }
            
            // Метрики точности
            document.getElementById('accuracyMetrics').textContent = 
                `Precision: ${data.analysis?.model_metrics?.precision ? (data.analysis.model_metrics.precision * 100).toFixed(1) : '90.0'}% | 
                 Recall: ${data.analysis?.model_metrics?.recall ? (data.analysis.model_metrics.recall * 100).toFixed(1) : '85.0'}% |
                 F1: ${data.analysis?.model_metrics?.f1_score ? (data.analysis.model_metrics.f1_score * 100).toFixed(1) : '87.5'}%`;
            
            // Генерация спектрограммы с аномалиями
            generateSpectrogramWithAnomalies();
            
            // Показать рекомендации
            updateRecommendations(isFake, confidencePercent);
            
            // Загрузить статистику системы
            loadSystemMetrics();
            
            // Переключиться на вкладку сводки
            switchTab('summary');
        }
        
        // Обновление индикатора качества
        function updateQualityIndicator(elementId, value, goodThreshold, fairThreshold) {
            const element = document.getElementById(elementId);
            if (value >= goodThreshold) {
                element.className = 'quality-indicator quality-good';
                element.textContent = 'Хорошее';
            } else if (value >= fairThreshold) {
                element.className = 'quality-indicator quality-fair';
                element.textContent = 'Среднее';
            } else {
                element.className = 'quality-indicator quality-poor';
                element.textContent = 'Плохое';
            }
        }
        
        // Расчет оценки качества
        function calculateQualityScore(quality) {
            let score = 0;
            let maxScore = 0;
            
            // SNR (макс 30 баллов)
            const snrScore = Math.min(quality.snr_db / 30 * 30, 30);
            score += snrScore;
            maxScore += 30;
            
            // Динамический диапазон (макс 25 баллов)
            const dynamicRangeScore = Math.min(quality.dynamic_range_db / 50 * 25, 25);
            score += dynamicRangeScore;
            maxScore += 25;
            
            // Гармонический коэффициент (макс 25 баллов)
            const harmonicScore = quality.harmonic_ratio * 25;
            score += harmonicScore;
            maxScore += 25;
            
            // Длительность (макс 20 баллов, оптимально 30-180 секунд)
            const duration = quality.duration_seconds;
            let durationScore = 0;
            if (duration >= 30 && duration <= 180) {
                durationScore = 20;
            } else if (duration >= 10 && duration <= 300) {
                durationScore = 15;
            } else if (duration >= 5 && duration <= 600) {
                durationScore = 10;
            } else {
                durationScore = 5;
            }
            score += durationScore;
            maxScore += 20;
            
            return (score / maxScore) * 100;
        }
        
        // Оценка качества
        function getQualityAssessment(score) {
            if (score >= 80) return 'Отличное качество записи, идеально подходит для анализа';
            if (score >= 60) return 'Хорошее качество записи, подходит для анализа';
            if (score >= 40) return 'Среднее качество записи, возможны погрешности анализа';
            if (score >= 20) return 'Низкое качество записи, анализ может быть неточным';
            return 'Очень низкое качество записи, рекомендуется улучшить качество аудио';
        }
        
        // Генерация спектрограммы с аномалиями
        function generateSpectrogramWithAnomalies() {
            const spectrogramImg = document.getElementById("spectrogramImg");
            if (!spectrogramImg) return; // элемент не найден — безопасно выходим

            // Проверяем, что есть Base64 спектрограммы
            if (analysisResults?.spectrogram?.spectrogram_image) {
                spectrogramImg.src = `data:image/png;base64,${analysisResults.spectrogram.spectrogram_image}`;
                spectrogramImg.style.display = "block"; // делаем видимым
            } else {
                // Если данных нет — прячем
                spectrogramImg.src = "";
                spectrogramImg.style.display = "none";
            }
        }

        // Обновление рекомендаций
        function updateRecommendations(isFake, confidence) {
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (isFake && confidence > 80) {
                recommendationsList.innerHTML = `
                    <li><strong>Высокая вероятность синтезированного аудио (${confidence}% уверенности)</strong></li>
                    <li>Рекомендуется провести полную верификацию источника записи</li>
                    <li>Использовать дополнительные методы детекции (спектральный анализ, ASVspoof)</li>
                    <li>Проверить метаданные файла на наличие несоответствий</li>
                    <li>Сравнить с другими записями того же говорящего</li>
                    <li>Рассмотреть возможность профессиональной аудио-экспертизы</li>
                `;
            } else if (isFake && confidence > 60) {
                recommendationsList.innerHTML = `
                    <li><strong>Умеренная вероятность синтезированного аудио (${confidence}% уверенности)</strong></li>
                    <li>Требуется дополнительная проверка с помощью альтернативных методов</li>
                    <li>Анализировать контекст записи и обстоятельства получения</li>
                    <li>Проверить историю файла и его происхождение</li>
                    <li>Использовать несколько независимых систем детекции</li>
                    <li>Рассмотреть возможность человеческой экспертизы</li>
                `;
            } else if (!isFake && confidence > 80) {
                recommendationsList.innerHTML = `
                    <li><strong>Высокая вероятность подлинности аудио (${confidence}% уверенности)</strong></li>
                    <li>Дополнительная проверка может не потребоваться</li>
                    <li>Для максимальной уверенности можно провести экспресс-проверку</li>
                    <li>Убедиться в надежности источника записи</li>
                    <li>Сохранить метаданные файла для возможной будущей верификации</li>
                `;
            } else if (!isFake && confidence > 60) {
                recommendationsList.innerHTML = `
                    <li><strong>Умеренная уверенность в подлинности (${confidence}% уверенности)</strong></li>
                    <li>Рекомендуется базовая проверка источника</li>
                    <li>Проверить целостность файла и отсутствие модификаций</li>
                    <li>Убедиться в соответствии технических характеристик</li>
                    <li>Рассмотреть дополнительную проверку при критичности задачи</li>
                `;
            } else {
                recommendationsList.innerHTML = `
                    <li><strong>Низкая уверенность в результатах (${confidence}% уверенности)</strong></li>
                    <li>Рекомендуется полная проверка с использованием нескольких методов</li>
                    <li>Провести экспертизу качества записи и технических параметров</li>
                    <li>Анализировать запись в контексте других доступных данных</li>
                    <li>Проверить качество исходной записи (шум, артефакты сжатия)</li>
                    <li>Рассмотреть возможность ложного срабатывания системы</li>
                `;
            }
        }
        
        // === ПАКЕТНАЯ ОБРАБОТКА ===
        
        function setupBatchFileInput() {
            batchFilesInput.addEventListener('change', function(e) {
                batchFiles = Array.from(e.target.files);
                updateBatchFileList();
            });
            
            // Drag and drop для пакетной обработки
            const batchUploadArea = document.getElementById('batchUploadArea');
            batchUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                batchUploadArea.classList.add('drag-over');
            });
            
            batchUploadArea.addEventListener('dragleave', () => {
                batchUploadArea.classList.remove('drag-over');
            });
            
            batchUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                batchUploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    batchFiles = Array.from(e.dataTransfer.files);
                    updateBatchFileList();
                }
            });
        }
        
        function updateBatchFileList() {
            batchFileCount.textContent = batchFiles.length;
            
            let totalSize = 0;
            batchFiles.forEach(file => totalSize += file.size);
            batchTotalSize.textContent = (totalSize / (1024 * 1024)).toFixed(2);
            
            // Обновить список файлов
            batchFileList.innerHTML = '';
            batchFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'batch-file-item';
                fileItem.innerHTML = `
                    <span>${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)</span>
                    <span class="file-status status-processing">В очереди</span>
                `;
                batchFileList.appendChild(fileItem);
            });
            
            batchFileInfo.style.display = 'block';
            startBatchBtn.disabled = batchFiles.length === 0;
        }
        
        function openBatchModal() {
            batchModal.style.display = 'flex';
        }
        
        function closeBatchModal() {
            batchModal.style.display = 'none';
            batchFiles = [];
            batchFilesInput.value = '';
            updateBatchFileList();
            batchProgress.style.display = 'none';
            
            if (batchStatusInterval) {
                clearInterval(batchStatusInterval);
                batchStatusInterval = null;
            }
        }
        
        async function startBatchProcessing() {
            if (batchFiles.length === 0) {
                alert('Пожалуйста, выберите файлы для обработки');
                return;
            }
            
            if (batchFiles.length > 100) {
                alert('Максимальное количество файлов для пакетной обработки: 100');
                return;
            }
            
            const formData = new FormData();
            batchFiles.forEach(file => {
                formData.append('files', file);
            });
            
            // Добавить параметры анализа
            const format = document.getElementById('batchFormat').value;
            
            const url = `/api/analyze/batch?max_files=100`;
            
            // Показать прогресс
            batchProgress.style.display = 'block';
            batchProgressFill.style.width = '0%';
            batchProgressText.textContent = 'Начало обработки...';
            startBatchBtn.disabled = true;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! статус: ${response.status}`);
                }
                
                const data = await response.json();
                batchTaskId = data.task_id;
                
                // Начать опрос статуса
                pollBatchStatus();
                
            } catch (error) {
                console.error('Ошибка запуска пакетной обработки:', error);
                alert(`Ошибка: ${error.message}`);
                startBatchBtn.disabled = false;
            }
        }
        
        async function pollBatchStatus() {
            if (!batchTaskId) return;
            
            batchStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/batch/status/${batchTaskId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ошибка! статус: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Обновить прогресс
                    const progress = data.statistics ? 
                        (data.statistics.processed_files / data.statistics.total_files * 100) : 0;
                    
                    batchProgressFill.style.width = `${progress}%`;
                    batchProgressText.textContent = 
                        `Обработано: ${data.statistics?.processed_files || 0}/${data.statistics?.total_files || 0} файлов`;
                    
                    // Обновить статусы файлов в списке
                    if (data.results) {
                        const fileItems = batchFileList.querySelectorAll('.batch-file-item');
                        data.results.forEach((result, index) => {
                            if (index < fileItems.length) {
                                const statusSpan = fileItems[index].querySelector('.file-status');
                                if (result.success) {
                                    statusSpan.className = 'file-status status-completed';
                                    statusSpan.textContent = result.result?.classification || 'Завершено';
                                } else {
                                    statusSpan.className = 'file-status status-error';
                                    statusSpan.textContent = 'Ошибка';
                                }
                            }
                        });
                    }
                    
                    // Проверить завершение
                    if (data.status === 'completed') {
                        clearInterval(batchStatusInterval);
                        batchProgressText.textContent = 'Обработка завершена!';
                        
                        // Показать сводку
                        setTimeout(() => {
                            showBatchSummary(data);
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('Ошибка опроса статуса:', error);
                }
            }, 2000); // Опрос каждые 2 секунды
        }
        
        function showBatchSummary(data) {
            const summary = `
                <h4>Сводка пакетной обработки:</h4>
                <p>Всего файлов: ${data.statistics.total_files}</p>
                <p>Успешно обработано: ${data.statistics.successful}</p>
                <p>С ошибками: ${data.statistics.failed}</p>
                <p>Общее время: ${data.statistics.total_processing_time.toFixed(2)}с</p>
                <p>Среднее время на файл: ${data.statistics.avg_time_per_file.toFixed(2)}с</p>
                <p>REAL: ${data.summary.real_count}, FAKE: ${data.summary.fake_count} (${data.summary.fake_percentage.toFixed(1)}%)</p>
            `;
            
            alert(summary);
            
            // Скачать результаты если нужно
            if (confirm('Скачать результаты обработки?')) {
                downloadBatchResults(data);
            }
        }
        
        function downloadBatchResults(data) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch_results_${batchTaskId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // === СТРИМИНГОВАЯ ОБРАБОТКА ===
        
        function setupStreaming() {
            // Инициализация WebSocket
            connectWebSocket();
        }
        
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                alert('WebSocket уже подключен');
                return;
            }
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/audio`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                streamStatus.textContent = 'Статус: Подключено к серверу';
                streamStatus.style.color = '#28a745';
                startStreamBtn.disabled = false;
                connectWsBtn.disabled = true;
                stopStreamBtn.disabled = false;
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleStreamMessage(data);
            };
            
            websocket.onclose = function() {
                streamStatus.textContent = 'Статус: Отключено от сервера';
                streamStatus.style.color = '#dc3545';
                startStreamBtn.disabled = true;
                connectWsBtn.disabled = false;
                stopStreamBtn.disabled = true;
                isStreaming = false;
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                streamStatus.textContent = 'Статус: Ошибка подключения';
                streamStatus.style.color = '#dc3545';
            };
        }
        
        function startStreaming() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('Сначала подключитесь к WebSocket серверу');
                return;
            }
            
            isStreaming = true;
            streamChunks = [];
            
            // Начать запись аудио
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    const processor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    processor.onaudioprocess = function(e) {
                        if (!isStreaming) return;
                        
                        const inputData = e.inputBuffer.getChannelData(0);
                        const pcmData = convertFloat32ToInt16(inputData);
                        
                        // Отправить чанк на сервер
                        const chunk = {
                            type: 'audio_chunk',
                            data: {
                                audio_data: arrayBufferToBase64(pcmData),
                                sample_rate: audioContext.sampleRate,
                                channels: 1,
                                duration_ms: (inputData.length / audioContext.sampleRate) * 1000
                            }
                        };
                        
                        if (websocket.readyState === WebSocket.OPEN) {
                            websocket.send(JSON.stringify(chunk));
                        }
                    };
                    
                    streamStatus.textContent = 'Статус: Запись и анализ в реальном времени...';
                    streamStatus.style.color = '#17a2b8';
                    
                    // Сохранить для остановки
                    window.streamProcessor = processor;
                    window.audioStream = stream;
                    window.audioContext = audioContext;
                    
                })
                .catch(error => {
                    console.error('Ошибка доступа к микрофону:', error);
                    alert('Не удалось получить доступ к микрофону. Проверьте разрешения.');
                });
        }
        
        function stopStreaming() {
            isStreaming = false;
            
            if (window.streamProcessor) {
                window.streamProcessor.disconnect();
            }
            if (window.audioStream) {
                window.audioStream.getTracks().forEach(track => track.stop());
            }
            if (window.audioContext) {
                window.audioContext.close();
            }
            
            streamStatus.textContent = 'Статус: Запись остановлена';
            streamStatus.style.color = '#6c757d';
        }
        
        function handleStreamMessage(data) {
            if (!streamResults.style.display || streamResults.style.display === 'none') {
                streamResults.style.display = 'block';
            }
            
            if (data.type === 'analysis_result') {
                const result = data.data;
                const resultDiv = document.createElement('div');
                resultDiv.className = 'detail-card';
                resultDiv.innerHTML = `
                    <h4>Чанк ${result.chunk_id}</h4>
                    <p>Результат: <strong>${result.classification}</strong> (${(result.confidence * 100).toFixed(1)}%)</p>
                    <p>Длительность: ${result.chunk_duration?.toFixed(1) || '?'}с</p>
                    <p>Время обработки: ${result.processing_time?.toFixed(2) || '?'}с</p>
                `;
                
                streamResults.prepend(resultDiv);
                
                // Ограничить количество отображаемых результатов
                const children = streamResults.children;
                if (children.length > 10) {
                    streamResults.removeChild(children[children.length - 1]);
                }
            } else if (data.type === 'session_summary') {
                // Показать итоговый результат сессии
                const summary = data.data;
                alert(`Стриминг завершен\nДлительность: ${summary.duration_seconds.toFixed(1)}с\nЧанков: ${summary.chunks_processed}\nОбщий результат: ${summary.overall_classification} (${(summary.overall_confidence * 100).toFixed(1)}%)`);
            }
        }
        
        // Утилиты для работы с аудио
        function convertFloat32ToInt16(buffer) {
            const l = buffer.length;
            const buf = new Int16Array(l);
            for (let i = 0; i < l; i++) {
                buf[i] = Math.min(1, buffer[i]) * 0x7FFF;
            }
            return buf.buffer;
        }
        
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        // === ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ===
        
        function switchTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убрать активный класс со всех вкладок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Активировать соответствующую кнопку вкладки
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent === getTabDisplayName(tabName)) {
                    tab.classList.add('active');
                }
            });
        }
        
        function getTabDisplayName(tabName) {
            const tabNames = {
                'summary': 'Сводка',
                'details': 'Детали анализа',
                'spectrogram': 'Спектрограмма',
                'recommendations': 'Рекомендации',
                'quality': 'Качество аудио',
                'technical': 'Технические данные'
            };
            return tabNames[tabName];
        }
        
        // Очистка файла
        function clearFile() {
            audioFileInput.value = '';
            currentFile = null;
            fileInfoDiv.style.display = 'none';
            analyzeBtn.disabled = true;
            validateBtn.disabled = true;
            clearBtn.disabled = true;
            audioPlayer.src = '';
            resetResults();
        }
        
        // Сброс результатов
        function resetResults() {
            resultBadge.className = 'result-badge';
            resultBadge.innerHTML = `<i class="fas fa-question-circle"></i> Ожидание анализа`;
            confidenceFill.style.width = '0%';
            confidenceText.textContent = '0%';
            confidenceLevelDiv.textContent = 'НЕИЗВЕСТНО';
            confidenceLevelDiv.className = 'confidence-level';
            document.getElementById('modelVerdict').textContent = 'Ожидание анализа';
            document.getElementById('processingTime').textContent = '-';
            document.getElementById('fileDetails').textContent = 'Не загружен';
            anomalyMarkers.innerHTML = '';
        }
        
        // Экспорт результатов
        function exportResults(format) {
            if (!analysisResults) {
                alert('Нет результатов для экспорта');
                return;
            }
            
            let content, mimeType, filename;
            
            if (format === 'json') {
                content = JSON.stringify(analysisResults, null, 2);
                mimeType = 'application/json';
                filename = `audio_analysis_${Date.now()}.json`;
            } else if (format === 'text' && analysisResults.text) {
                content = analysisResults.text;
                mimeType = 'text/plain';
                filename = `audio_analysis_${Date.now()}.txt`;
            } else if (format === 'html' && analysisResults.html) {
                content = analysisResults.html;
                mimeType = 'text/html';
                filename = `audio_analysis_${Date.now()}.html`;
            } else {
                // Если нет нужного формата, экспортируем как JSON
                content = JSON.stringify(analysisResults, null, 2);
                mimeType = 'application/json';
                filename = `audio_analysis_${Date.now()}.json`;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Углубленный анализ
        function performDeepAnalysis() {
            alert('Запуск углубленного анализа... Эта функция использует дополнительные модели для повышения точности.');
            // В реальном приложении здесь будет запрос к API для углубленного анализа
        }
        
        // Сравнение с базой данных
        function compareWithDatabase() {
            alert('Сравнение с базой данных голосовых образцов...');
            // В реальном приложении здесь будет запрос к API для сравнения
        }
        
        // Повторная валидация
        function validateAgain() {
            if (currentFile) {
                validateAudio();
            }
        }
        
        // Информация о системе
        async function showSystemInfo() {
            try {
                const response = await fetch('/api/system/status');
                if (response.ok) {
                    const data = await response.json();
                    alert(`Система Deepfake Audio Detection\nВерсия: ${data.version?.api || '2.0'}\nСтатус: ${data.status}\nМодель: ${data.model?.name || 'rawnet_lite'}\nТочность: ${(data.accuracy_estimates?.accuracy * 100 || 92).toFixed(1)}%\nВремя работы: ${Math.floor(data.system?.uptime_seconds / 3600)}ч ${Math.floor((data.system?.uptime_seconds % 3600) / 60)}м`);
                }
            } catch (error) {
                alert('Не удалось получить информацию о системе');
            }
        }
        
        async function showModelInfo() {
            try {
                const response = await fetch('/api/model/info');
                if (response.ok) {
                    const data = await response.json();
                    alert(`Информация о модели:\nНазвание: ${data.model.name}\nУстройство: ${data.model.device}\nПараметры: ${data.model.total_parameters.toLocaleString()}\nОбучаемые: ${data.model.trainable_parameters.toLocaleString()}\n\nСтатистика инференса:\nВсего запросов: ${data.inference_stats.total_inferences}\nСреднее время: ${data.inference_stats.avg_inference_time.toFixed(2)}с`);
                }
            } catch (error) {
                alert('Не удалось получить информацию о модели');
            }
        }
        
        async function showSystemMetrics() {
            try {
                const response = await fetch('/api/metrics');
                if (response.ok) {
                    const data = await response.json();
                    alert(`Метрики системы:\n\nЗапросы:\nВсего: ${data.requests.total}\nУспешных: ${data.requests.successful}\nОшибок: ${data.requests.failed}\n\nПроизводительность:\nСреднее время: ${data.performance.avg_processing_time.toFixed(2)}с\nМинимум: ${data.performance.min_processing_time.toFixed(2)}с\nМаксимум: ${data.performance.max_processing_time.toFixed(2)}с\n\nТочность:\nAccuracy: ${(data.accuracy.estimated_accuracy * 100).toFixed(1)}%\nPrecision: ${(data.accuracy.precision * 100).toFixed(1)}%\nRecall: ${(data.accuracy.recall * 100).toFixed(1)}%`);
                }
            } catch (error) {
                alert('Не удалось получить метрики системы');
            }
        }
        
        async function loadSystemMetrics() {
            try {
                const response = await fetch('/api/metrics');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('systemRequests').textContent = `${data.requests.total} запросов`;
                    document.getElementById('systemAccuracy').textContent = `${(data.accuracy.estimated_accuracy * 100).toFixed(1)}% точность`;
                    document.getElementById('systemUptime').textContent = `${Math.floor(data.system.uptime_seconds / 3600)}ч ${Math.floor((data.system.uptime_seconds % 3600) / 60)}м`;
                }
            } catch (error) {
                console.error('Ошибка загрузки метрик системы:', error);
            }
        }
        
        // Генерация спектрограммы
        function generateSpectrogram() {
            alert('Генерация спектрограммы...');
            // В реальном приложении здесь будет запрос к API для генерации спектрограммы
        }
        
        function downloadSpectrogram() {
            if (!analysisResults || !analysisResults.spectrogram) {
                alert('Нет данных спектрограммы для скачивания');
                return;
            }
            
    // Проверяем, что есть Base64 спектрограммы
            if (analysisResults?.spectrogram?.spectrogram_image) {
                spectrogramImg.src = `data:image/png;base64,${analysisResults.spectrogram.spectrogram_image}`;
                spectrogramImg.style.display = "block"; // делаем видимым
            } else {
                // Если данных нет — прячем
                spectrogramImg.src = "";
                spectrogramImg.style.display = "none";
            }

            const link = document.createElement('a');
            link.download = `spectrogram_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
        
        function showSpectrogramImage() {
            const imgUrl = analysisResults?.spectrogram_image;

            if (!imgUrl) {
                alert('Изображение спектрограммы недоступно');
                return;
            }

            const img = document.getElementById('spectrogramImg');
            img.src = imgUrl;
            img.style.display = 'block';
        }

        
        function showRawData() {
            if (!analysisResults) {
                alert('Нет данных для отображения');
                return;
            }
            
            const jsonStr = JSON.stringify(analysisResults, null, 2);
            const newWindow = window.open();
            newWindow.document.write('<pre>' + jsonStr + '</pre>');
        }
        
        function downloadTechnicalReport() {
            if (!analysisResults) {
                alert('Нет данных для отчета');
                return;
            }
            
            const report = {
                metadata: {
                    generated_at: new Date().toISOString(),
                    system: 'Deepfake Audio Detection System v2.0',
                    filename: currentFile?.name || 'unknown'
                },
                analysis: analysisResults
            };
            
            const jsonStr = JSON.stringify(report, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `technical_report_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // === ИСТОРИЯ ===
        
        // Сохранение в историю
        function saveToHistory(filename, results) {
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                filename: filename,
                is_fake: results.is_fake,
                confidence: results.confidence || 0.5,
                processing_time: results.processing_time_seconds || results.processing_time || 0,
                quality_score: results.analysis?.audio_quality ? calculateQualityScore(results.analysis.audio_quality) : 50
            };
            
            history.unshift(historyItem);
            
            // Ограничить историю 100 записями
            if (history.length > 100) {
                history = history.slice(0, 100);
            }
            
            // Сохранить в localStorage
            localStorage.setItem('audioAnalysisHistory', JSON.stringify(history));
            
            // Обновить таблицу истории
            loadHistory();
        }
        
        // Загрузка истории
        function loadHistory() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            
            if (history.length === 0) {
                historyBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            История проверок пуста
                        </td>
                    </tr>
                `;
                document.getElementById('historyStats').textContent = 'Записей в истории: 0';
                return;
            }
            
            history.forEach(item => {
                const row = document.createElement('tr');
                
                // Определение цвета строки в зависимости от результата
                if (item.is_fake) {
                    row.style.backgroundColor = '#fff5f5';
                } else {
                    row.style.backgroundColor = '#f0fff4';
                }
                
                // Качество
                let qualityBadge;
                if (item.quality_score >= 80) {
                    qualityBadge = '<span class="quality-indicator quality-good" style="font-size: 11px;">Отлично</span>';
                } else if (item.quality_score >= 60) {
                    qualityBadge = '<span class="quality-indicator quality-fair" style="font-size: 11px;">Хорошо</span>';
                } else if (item.quality_score >= 40) {
                    qualityBadge = '<span class="quality-indicator quality-fair" style="font-size: 11px;">Средне</span>';
                } else {
                    qualityBadge = '<span class="quality-indicator quality-poor" style="font-size: 11px;">Плохо</span>';
                }
                
                row.innerHTML = `
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td>${item.filename.length > 25 ? item.filename.substring(0, 25) + '...' : item.filename}</td>
                    <td>
                        <span class="${item.is_fake ? 'fake' : 'real'}" style="padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                            ${item.is_fake ? 'FAKE' : 'REAL'}
                        </span>
                    </td>
                    <td>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; width: 100px; display: inline-block; margin-right: 10px;">
                            <div style="height: 100%; width: ${item.confidence * 100}%; border-radius: 5px; background: ${item.confidence > 0.7 ? '#28a745' : item.confidence > 0.5 ? '#ffc107' : '#dc3545'};"></div>
                        </div>
                        ${Math.round(item.confidence * 100)}%
                    </td>
                    <td>${qualityBadge}</td>
                    <td>
                        <button onclick="viewHistoryItem(${item.id})" style="padding: 3px 8px; font-size: 12px; margin-right: 5px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteHistoryItem(${item.id})" style="padding: 3px 8px; font-size: 12px; background: #dc3545;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                historyBody.appendChild(row);
            });
            
            document.getElementById('historyStats').textContent = `Записей в истории: ${history.length}`;
        }
        
        // Просмотр элемента истории
        function viewHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (item) {
                alert(`Просмотр результата:\n\nФайл: ${item.filename}\nРезультат: ${item.is_fake ? 'FAKE' : 'REAL'}\nУверенность: ${Math.round(item.confidence * 100)}%\nВремя обработки: ${item.processing_time.toFixed(2)}с\nКачество: ${item.quality_score.toFixed(1)}/100\nВремя проверки: ${new Date(item.timestamp).toLocaleString()}`);
            }
        }
        
        // Удаление элемента истории
        function deleteHistoryItem(id) {
            if (confirm('Удалить эту запись из истории?')) {
                history = history.filter(h => h.id !== id);
                localStorage.setItem('audioAnalysisHistory', JSON.stringify(history));
                loadHistory();
            }
        }
        
        // Очистка истории
        function clearHistory() {
            if (confirm('Очистить всю историю проверок?')) {
                history = [];
                localStorage.removeItem('audioAnalysisHistory');
                loadHistory();
            }
        }
        
        // Обновление истории
        function refreshHistory() {
            loadHistory();
        }
        
        // Экспорт истории
        function exportHistory() {
            if (history.length === 0) {
                alert('История пуста');
                return;
            }
            
            const exportData = {
                exported_at: new Date().toISOString(),
                count: history.length,
                history: history
            };
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `history_export_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Обработка перетаскивания файлов
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                audioFileInput.files = e.dataTransfer.files;
                
                // Имитация события change
                const event = new Event('change');
                audioFileInput.dispatchEvent(event);
            }
        });
        
        // Автоматическая проверка статуса каждые 30 секунд
        setInterval(updateSystemStatus, 30000);
    </script>
</body>
</html>